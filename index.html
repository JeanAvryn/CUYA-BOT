<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='uploads/chatbot.png') }}">
  <title>CUYA-BOT | Cuyapo's Chatbot</title>
  <style>
    :root {
      --light-bg: #f1f1f1;
      --dark-bg: #1e1e1e;
      --light-box: white;
      --dark-box: #2a2a2a;
      --light-text: #000;
      --dark-text: #fff;
      --bot-light: #f1f0f0;
      --bot-dark: #3a3a3a;
    }

    body {
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      background: linear-gradient(135deg, var(--light-bg), #e0e0e0);
      color: var(--light-text);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      transition: 0.3s;
    }

    body.dark-mode {
      background: linear-gradient(135deg, var(--dark-bg), #000);
      color: var(--dark-text);
    }

    h2 {
      text-align: center;
      color: inherit;
      margin-bottom: 10px;
    }

    #chat-container {
      width: 400px;
      background: var(--light-box);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    body.dark-mode #chat-container {
      background: var(--dark-box);
      box-shadow: 0 0 20px rgba(255,255,255,0.1);
    }

    #chat-box {
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }

    .user, .bot {
      margin: 10px 0;
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 80%;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .user {
      background-color: #0765fe;
      color: white;
      align-self: flex-end;
      text-align: right;
      border-bottom-right-radius: 0;
    }

    .bot {
      background-color: var(--bot-light);
      align-self: flex-start;
      text-align: left;
      border-bottom-left-radius: 0;
    }

    body.dark-mode .bot {
      background-color: var(--bot-dark);
      color: var(--dark-text);
    }

    #message {
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      width: 70%;
      padding: 8px;
    }

    #send {
      font-weight: bold;
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      padding: 8px 25px;
    }

    .dots span {
      animation: blink 1s infinite;
      opacity: 0;
    }

    .dots span:nth-child(1) { animation-delay: 0s; }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }

  
    @keyframes blink {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }

    .toggle-btn {
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      background: #333;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    @media (max-width: 500px) {
      #chat-container {
        width: 90%;
        padding: 15px;
      }

      #message {
        width: 65%;
      }

      #send {
        width: 30%;
      }
    }

    .user, .bot {
  animation: popin 0.3s ease;
}

  @keyframes popin {
  0% { transform: translateY(10px); opacity: 0; }
  100% { transform: translateY(0); opacity: 1; }
}
  </style>
</head>
<body>
  <div id="chat-container">
    <button style="font-family: Verdana, Geneva, Tahoma, sans-serif;" onclick="startNewChat()">+ New Chat</button>
    <h2>ü§ñ CUYA-BOT: your localized emergency assistant</h2>
    <button class="toggle-btn" onclick="toggleDarkMode()">üåó Toggle Dark Mode</button>
    <div id="chat-box">
      <!-- Chat messages appear here -->
      <div id="typing-indicator" class="bot" style="display: none;">
        ü§ñ <span class="dots">Typing<span>.</span><span>.</span><span>.</span></span>
      </div>
    </div>
    <input type="text" id="message" placeholder="Type your message..." />
    <button id="send">Send</button>
    <form id="chat-form" enctype="multipart/form-data">
</form>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    window.onload = () => {
  appendMessage("bot", "üëã Hello! I‚Äôm CUYA-BOT, your emergency assistant.\nüìù Try saying something like ‚ÄòMay sunog!‚Äô or ‚ÄòThere‚Äôs a flood here!‚Äô to report an emergency.");
};

    const messageInput = document.getElementById("message");
    const sendBtn = document.getElementById("send");

    const form = document.getElementById("chat-form");

form.onsubmit = async (e) => {
  e.preventDefault();

  const userMessage = messageInput.value.trim();
  const image = document.getElementById("image").files[0];

  if (!userMessage && !image) return;

  appendMessage("user", userMessage || "[üì∑ Image Uploaded]");
  messageInput.value = "";
  document.getElementById("image").value = "";

  const formData = new FormData();
  formData.append("message", userMessage);
  if (image) formData.append("image", image);

  typingIndicator.style.display = "block";

  try {
    const response = await fetch("/chat", {
      method: "POST",
      body: formData,
    });
    const data = await response.json();
    typingIndicator.style.display = "none";
    appendMessage("bot", data.reply);
  } catch (error) {
    typingIndicator.style.display = "none";
    appendMessage("bot", "‚ö†Ô∏è Error contacting CUYA-BOT.");
  }
};

    function appendMessage(sender, text) {
  const msg = document.createElement("div");
  msg.className = sender;

  const time = new Date();
  const hours = time.getHours();
  const minutes = time.getMinutes().toString().padStart(2, "0");
  const ampm = hours >= 12 ? "PM" : "AM";
  const formattedTime = `${((hours + 11) % 12 + 1)}:${minutes} ${ampm}`;

  const icon = sender === "user" ? "üßç" : "ü§ñ";

  msg.innerHTML = `<strong>${icon}</strong> ${text}<br><small style="font-size: 0.75rem; color: #666;">${formattedTime}</small>`;
  chatBox.insertBefore(msg, document.getElementById("typing-indicator"));
  chatBox.scrollTop = chatBox.scrollHeight;
}


    sendBtn.onclick = async () => {
      const userMessage = messageInput.value.trim();
      if (!userMessage) return;

      appendMessage("user", userMessage);
      messageInput.value = "";

      // Show typing animation
      const typingIndicator = document.getElementById("typing-indicator");
      typingIndicator.style.display = "block";
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const response = await fetch("/chat", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ message: userMessage })
});

const data = await response.json();

// Simulate typing delay (e.g., 1.5 seconds)
setTimeout(() => {
  typingIndicator.style.display = "none";
  appendMessage("bot", data.reply);
}, 1000); // 1500 milliseconds = 1.5 seconds

      } catch (error) {
        typingIndicator.style.display = "none";
        appendMessage("bot", "‚ö†Ô∏è Error contacting CUYA-BOT.");
      }
    };

    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

// dark mode
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
}

// New chat
function startNewChat() {
  if (confirm("Start a new conversation?")) {
    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML = '';

    // Re-append typing indicator (if it was removed)
    const typingDiv = document.createElement("div");
    typingDiv.id = "typing-indicator";
    typingDiv.className = "bot";
    typingDiv.style.display = "none";
    typingDiv.innerHTML = 'ü§ñ <span class="dots">Typing<span>.</span><span>.</span><span>.</span></span>';
    chatBox.appendChild(typingDiv);

    // Trigger the initial bot message
    appendMessage("bot", "üëã Hello! I‚Äôm CUYA-BOT, your emergency assistant.\nüìù Try saying something like ‚ÄòMay sunog!‚Äô or ‚ÄòThere‚Äôs a flood here!‚Äô to report an emergency.");
  }
}

  </script>
</body>
</html>
